<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.1//EN"
    "http://www.w3.org/TR/xhtml11/DTD/xhtml11.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en">
<head>
<meta http-equiv="Content-Type" content="application/xhtml+xml; charset=UTF-8" />
<meta name="generator" content="AsciiDoc 8.6.9" />
<title>The GNU APL Communication Cookbook</title>
<style type="text/css">
/* Shared CSS for AsciiDoc xhtml11 and html5 backends */

/* Default font. */
body {
  font-family: Georgia,serif;
}

/* Title font. */
h1, h2, h3, h4, h5, h6,
div.title, caption.title,
thead, p.table.header,
#toctitle,
#author, #revnumber, #revdate, #revremark,
#footer {
  font-family: Arial,Helvetica,sans-serif;
}

body {
  margin: 1em 5% 1em 5%;
}

a {
  color: blue;
  text-decoration: underline;
}
a:visited {
  color: fuchsia;
}

em {
  font-style: italic;
  color: navy;
}

strong {
  font-weight: bold;
  color: #083194;
}

h1, h2, h3, h4, h5, h6 {
  color: #527bbd;
  margin-top: 1.2em;
  margin-bottom: 0.5em;
  line-height: 1.3;
}

h1, h2, h3 {
  border-bottom: 2px solid silver;
}
h2 {
  padding-top: 0.5em;
}
h3 {
  float: left;
}
h3 + * {
  clear: left;
}
h5 {
  font-size: 1.0em;
}

div.sectionbody {
  margin-left: 0;
}

hr {
  border: 1px solid silver;
}

p {
  margin-top: 0.5em;
  margin-bottom: 0.5em;
}

ul, ol, li > p {
  margin-top: 0;
}
ul > li     { color: #aaa; }
ul > li > * { color: black; }

.monospaced, code, pre {
  font-family: "Courier New", Courier, monospace;
  font-size: inherit;
  color: navy;
  padding: 0;
  margin: 0;
}
pre {
  white-space: pre-wrap;
}

#author {
  color: #527bbd;
  font-weight: bold;
  font-size: 1.1em;
}
#email {
}
#revnumber, #revdate, #revremark {
}

#footer {
  font-size: small;
  border-top: 2px solid silver;
  padding-top: 0.5em;
  margin-top: 4.0em;
}
#footer-text {
  float: left;
  padding-bottom: 0.5em;
}
#footer-badges {
  float: right;
  padding-bottom: 0.5em;
}

#preamble {
  margin-top: 1.5em;
  margin-bottom: 1.5em;
}
div.imageblock, div.exampleblock, div.verseblock,
div.quoteblock, div.literalblock, div.listingblock, div.sidebarblock,
div.admonitionblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.admonitionblock {
  margin-top: 2.0em;
  margin-bottom: 2.0em;
  margin-right: 10%;
  color: #606060;
}

div.content { /* Block element content. */
  padding: 0;
}

/* Block element titles. */
div.title, caption.title {
  color: #527bbd;
  font-weight: bold;
  text-align: left;
  margin-top: 1.0em;
  margin-bottom: 0.5em;
}
div.title + * {
  margin-top: 0;
}

td div.title:first-child {
  margin-top: 0.0em;
}
div.content div.title:first-child {
  margin-top: 0.0em;
}
div.content + div.title {
  margin-top: 0.0em;
}

div.sidebarblock > div.content {
  background: #ffffee;
  border: 1px solid #dddddd;
  border-left: 4px solid #f0f0f0;
  padding: 0.5em;
}

div.listingblock > div.content {
  border: 1px solid #dddddd;
  border-left: 5px solid #f0f0f0;
  background: #f8f8f8;
  padding: 0.5em;
}

div.quoteblock, div.verseblock {
  padding-left: 1.0em;
  margin-left: 1.0em;
  margin-right: 10%;
  border-left: 5px solid #f0f0f0;
  color: #888;
}

div.quoteblock > div.attribution {
  padding-top: 0.5em;
  text-align: right;
}

div.verseblock > pre.content {
  font-family: inherit;
  font-size: inherit;
}
div.verseblock > div.attribution {
  padding-top: 0.75em;
  text-align: left;
}
/* DEPRECATED: Pre version 8.2.7 verse style literal block. */
div.verseblock + div.attribution {
  text-align: left;
}

div.admonitionblock .icon {
  vertical-align: top;
  font-size: 1.1em;
  font-weight: bold;
  text-decoration: underline;
  color: #527bbd;
  padding-right: 0.5em;
}
div.admonitionblock td.content {
  padding-left: 0.5em;
  border-left: 3px solid #dddddd;
}

div.exampleblock > div.content {
  border-left: 3px solid #dddddd;
  padding-left: 0.5em;
}

div.imageblock div.content { padding-left: 0; }
span.image img { border-style: none; vertical-align: text-bottom; }
a.image:visited { color: white; }

dl {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
dt {
  margin-top: 0.5em;
  margin-bottom: 0;
  font-style: normal;
  color: navy;
}
dd > *:first-child {
  margin-top: 0.1em;
}

ul, ol {
    list-style-position: outside;
}
ol.arabic {
  list-style-type: decimal;
}
ol.loweralpha {
  list-style-type: lower-alpha;
}
ol.upperalpha {
  list-style-type: upper-alpha;
}
ol.lowerroman {
  list-style-type: lower-roman;
}
ol.upperroman {
  list-style-type: upper-roman;
}

div.compact ul, div.compact ol,
div.compact p, div.compact p,
div.compact div, div.compact div {
  margin-top: 0.1em;
  margin-bottom: 0.1em;
}

tfoot {
  font-weight: bold;
}
td > div.verse {
  white-space: pre;
}

div.hdlist {
  margin-top: 0.8em;
  margin-bottom: 0.8em;
}
div.hdlist tr {
  padding-bottom: 15px;
}
dt.hdlist1.strong, td.hdlist1.strong {
  font-weight: bold;
}
td.hdlist1 {
  vertical-align: top;
  font-style: normal;
  padding-right: 0.8em;
  color: navy;
}
td.hdlist2 {
  vertical-align: top;
}
div.hdlist.compact tr {
  margin: 0;
  padding-bottom: 0;
}

.comment {
  background: yellow;
}

.footnote, .footnoteref {
  font-size: 0.8em;
}

span.footnote, span.footnoteref {
  vertical-align: super;
}

#footnotes {
  margin: 20px 0 20px 0;
  padding: 7px 0 0 0;
}

#footnotes div.footnote {
  margin: 0 0 5px 0;
}

#footnotes hr {
  border: none;
  border-top: 1px solid silver;
  height: 1px;
  text-align: left;
  margin-left: 0;
  width: 20%;
  min-width: 100px;
}

div.colist td {
  padding-right: 0.5em;
  padding-bottom: 0.3em;
  vertical-align: top;
}
div.colist td img {
  margin-top: 0.3em;
}

@media print {
  #footer-badges { display: none; }
}

#toc {
  margin-bottom: 2.5em;
}

#toctitle {
  color: #527bbd;
  font-size: 1.1em;
  font-weight: bold;
  margin-top: 1.0em;
  margin-bottom: 0.1em;
}

div.toclevel0, div.toclevel1, div.toclevel2, div.toclevel3, div.toclevel4 {
  margin-top: 0;
  margin-bottom: 0;
}
div.toclevel2 {
  margin-left: 2em;
  font-size: 0.9em;
}
div.toclevel3 {
  margin-left: 4em;
  font-size: 0.9em;
}
div.toclevel4 {
  margin-left: 6em;
  font-size: 0.9em;
}

span.aqua { color: aqua; }
span.black { color: black; }
span.blue { color: blue; }
span.fuchsia { color: fuchsia; }
span.gray { color: gray; }
span.green { color: green; }
span.lime { color: lime; }
span.maroon { color: maroon; }
span.navy { color: navy; }
span.olive { color: olive; }
span.purple { color: purple; }
span.red { color: red; }
span.silver { color: silver; }
span.teal { color: teal; }
span.white { color: white; }
span.yellow { color: yellow; }

span.aqua-background { background: aqua; }
span.black-background { background: black; }
span.blue-background { background: blue; }
span.fuchsia-background { background: fuchsia; }
span.gray-background { background: gray; }
span.green-background { background: green; }
span.lime-background { background: lime; }
span.maroon-background { background: maroon; }
span.navy-background { background: navy; }
span.olive-background { background: olive; }
span.purple-background { background: purple; }
span.red-background { background: red; }
span.silver-background { background: silver; }
span.teal-background { background: teal; }
span.white-background { background: white; }
span.yellow-background { background: yellow; }

span.big { font-size: 2em; }
span.small { font-size: 0.6em; }

span.underline { text-decoration: underline; }
span.overline { text-decoration: overline; }
span.line-through { text-decoration: line-through; }

div.unbreakable { page-break-inside: avoid; }


/*
 * xhtml11 specific
 *
 * */

div.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
div.tableblock > table {
  border: 3px solid #527bbd;
}
thead, p.table.header {
  font-weight: bold;
  color: #527bbd;
}
p.table {
  margin-top: 0;
}
/* Because the table frame attribute is overriden by CSS in most browsers. */
div.tableblock > table[frame="void"] {
  border-style: none;
}
div.tableblock > table[frame="hsides"] {
  border-left-style: none;
  border-right-style: none;
}
div.tableblock > table[frame="vsides"] {
  border-top-style: none;
  border-bottom-style: none;
}


/*
 * html5 specific
 *
 * */

table.tableblock {
  margin-top: 1.0em;
  margin-bottom: 1.5em;
}
thead, p.tableblock.header {
  font-weight: bold;
  color: #527bbd;
}
p.tableblock {
  margin-top: 0;
}
table.tableblock {
  border-width: 3px;
  border-spacing: 0px;
  border-style: solid;
  border-color: #527bbd;
  border-collapse: collapse;
}
th.tableblock, td.tableblock {
  border-width: 1px;
  padding: 4px;
  border-style: solid;
  border-color: #527bbd;
}

table.tableblock.frame-topbot {
  border-left-style: hidden;
  border-right-style: hidden;
}
table.tableblock.frame-sides {
  border-top-style: hidden;
  border-bottom-style: hidden;
}
table.tableblock.frame-none {
  border-style: hidden;
}

th.tableblock.halign-left, td.tableblock.halign-left {
  text-align: left;
}
th.tableblock.halign-center, td.tableblock.halign-center {
  text-align: center;
}
th.tableblock.halign-right, td.tableblock.halign-right {
  text-align: right;
}

th.tableblock.valign-top, td.tableblock.valign-top {
  vertical-align: top;
}
th.tableblock.valign-middle, td.tableblock.valign-middle {
  vertical-align: middle;
}
th.tableblock.valign-bottom, td.tableblock.valign-bottom {
  vertical-align: bottom;
}


/*
 * manpage specific
 *
 * */

body.manpage h1 {
  padding-top: 0.5em;
  padding-bottom: 0.5em;
  border-top: 2px solid silver;
  border-bottom: 2px solid silver;
}
body.manpage h2 {
  border-style: none;
}
body.manpage div.sectionbody {
  margin-left: 3em;
}

@media print {
  body.manpage div#toc { display: none; }
}


</style>
<script type="text/javascript">
/*<![CDATA[*/
var asciidoc = {  // Namespace.

/////////////////////////////////////////////////////////////////////
// Table Of Contents generator
/////////////////////////////////////////////////////////////////////

/* Author: Mihai Bazon, September 2002
 * http://students.infoiasi.ro/~mishoo
 *
 * Table Of Content generator
 * Version: 0.4
 *
 * Feel free to use this script under the terms of the GNU General Public
 * License, as long as you do not remove or alter this notice.
 */

 /* modified by Troy D. Hanson, September 2006. License: GPL */
 /* modified by Stuart Rackham, 2006, 2009. License: GPL */

// toclevels = 1..4.
toc: function (toclevels) {

  function getText(el) {
    var text = "";
    for (var i = el.firstChild; i != null; i = i.nextSibling) {
      if (i.nodeType == 3 /* Node.TEXT_NODE */) // IE doesn't speak constants.
        text += i.data;
      else if (i.firstChild != null)
        text += getText(i);
    }
    return text;
  }

  function TocEntry(el, text, toclevel) {
    this.element = el;
    this.text = text;
    this.toclevel = toclevel;
  }

  function tocEntries(el, toclevels) {
    var result = new Array;
    var re = new RegExp('[hH]([1-'+(toclevels+1)+'])');
    // Function that scans the DOM tree for header elements (the DOM2
    // nodeIterator API would be a better technique but not supported by all
    // browsers).
    var iterate = function (el) {
      for (var i = el.firstChild; i != null; i = i.nextSibling) {
        if (i.nodeType == 1 /* Node.ELEMENT_NODE */) {
          var mo = re.exec(i.tagName);
          if (mo && (i.getAttribute("class") || i.getAttribute("className")) != "float") {
            result[result.length] = new TocEntry(i, getText(i), mo[1]-1);
          }
          iterate(i);
        }
      }
    }
    iterate(el);
    return result;
  }

  var toc = document.getElementById("toc");
  if (!toc) {
    return;
  }

  // Delete existing TOC entries in case we're reloading the TOC.
  var tocEntriesToRemove = [];
  var i;
  for (i = 0; i < toc.childNodes.length; i++) {
    var entry = toc.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div'
     && entry.getAttribute("class")
     && entry.getAttribute("class").match(/^toclevel/))
      tocEntriesToRemove.push(entry);
  }
  for (i = 0; i < tocEntriesToRemove.length; i++) {
    toc.removeChild(tocEntriesToRemove[i]);
  }

  // Rebuild TOC entries.
  var entries = tocEntries(document.getElementById("content"), toclevels);
  for (var i = 0; i < entries.length; ++i) {
    var entry = entries[i];
    if (entry.element.id == "")
      entry.element.id = "_toc_" + i;
    var a = document.createElement("a");
    a.href = "#" + entry.element.id;
    a.appendChild(document.createTextNode(entry.text));
    var div = document.createElement("div");
    div.appendChild(a);
    div.className = "toclevel" + entry.toclevel;
    toc.appendChild(div);
  }
  if (entries.length == 0)
    toc.parentNode.removeChild(toc);
},


/////////////////////////////////////////////////////////////////////
// Footnotes generator
/////////////////////////////////////////////////////////////////////

/* Based on footnote generation code from:
 * http://www.brandspankingnew.net/archive/2005/07/format_footnote.html
 */

footnotes: function () {
  // Delete existing footnote entries in case we're reloading the footnodes.
  var i;
  var noteholder = document.getElementById("footnotes");
  if (!noteholder) {
    return;
  }
  var entriesToRemove = [];
  for (i = 0; i < noteholder.childNodes.length; i++) {
    var entry = noteholder.childNodes[i];
    if (entry.nodeName.toLowerCase() == 'div' && entry.getAttribute("class") == "footnote")
      entriesToRemove.push(entry);
  }
  for (i = 0; i < entriesToRemove.length; i++) {
    noteholder.removeChild(entriesToRemove[i]);
  }

  // Rebuild footnote entries.
  var cont = document.getElementById("content");
  var spans = cont.getElementsByTagName("span");
  var refs = {};
  var n = 0;
  for (i=0; i<spans.length; i++) {
    if (spans[i].className == "footnote") {
      n++;
      var note = spans[i].getAttribute("data-note");
      if (!note) {
        // Use [\s\S] in place of . so multi-line matches work.
        // Because JavaScript has no s (dotall) regex flag.
        note = spans[i].innerHTML.match(/\s*\[([\s\S]*)]\s*/)[1];
        spans[i].innerHTML =
          "[<a id='_footnoteref_" + n + "' href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
        spans[i].setAttribute("data-note", note);
      }
      noteholder.innerHTML +=
        "<div class='footnote' id='_footnote_" + n + "'>" +
        "<a href='#_footnoteref_" + n + "' title='Return to text'>" +
        n + "</a>. " + note + "</div>";
      var id =spans[i].getAttribute("id");
      if (id != null) refs["#"+id] = n;
    }
  }
  if (n == 0)
    noteholder.parentNode.removeChild(noteholder);
  else {
    // Process footnoterefs.
    for (i=0; i<spans.length; i++) {
      if (spans[i].className == "footnoteref") {
        var href = spans[i].getElementsByTagName("a")[0].getAttribute("href");
        href = href.match(/#.*/)[0];  // Because IE return full URL.
        n = refs[href];
        spans[i].innerHTML =
          "[<a href='#_footnote_" + n +
          "' title='View footnote' class='footnote'>" + n + "</a>]";
      }
    }
  }
},

install: function(toclevels) {
  var timerId;

  function reinstall() {
    asciidoc.footnotes();
    if (toclevels) {
      asciidoc.toc(toclevels);
    }
  }

  function reinstallAndRemoveTimer() {
    clearInterval(timerId);
    reinstall();
  }

  timerId = setInterval(reinstall, 500);
  if (document.addEventListener)
    document.addEventListener("DOMContentLoaded", reinstallAndRemoveTimer, false);
  else
    window.onload = reinstallAndRemoveTimer;
}

}
asciidoc.install();
/*]]>*/
</script>
</head>
<body class="article">
<div id="header">
<h1>The GNU APL Communication Cookbook</h1>
<span id="author">Dr. Jürgen Sauermann, GNU APL</span><br />
</div>
<div id="content">
<div class="sect1">
<h2 id="_abstract">Abstract</h2>
<div class="sectionbody">
<div class="paragraph"><p>GNU APL provides a number of communication mechanisms that allow it to
control other programs or to be controlled by other programs. With these
communication mechanisms one can construct larger systems in which GNU APL
is only one component. This document gives an overview of the communication
mechanisms, so that the reader can choose the most appropriate mechanisms
for a given problem.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_terminology">Terminology</h2>
<div class="sectionbody">
<div class="paragraph"><p>A <strong>server</strong> is a program or process that is being controlled by one or more
other programs or processes. A <strong>client</strong> is a program or process that controls
another program or process. A <strong>peer</strong> is a program or process that communicates
with GNU APL, but is not a client or a server with respect to that
communication. In a client/server communication, it is the client that
establishes the communication link between the two partners.</p></div>
<div class="paragraph"><p>In general the communication between a client and a server is somewhat simpler
than the communication between two peers. The role of one communication
partner dictates the role of the other:</p></div>
<div class="tableblock">
<table rules="all"
width="60%"
frame="border"
cellspacing="0" cellpadding="4">
<caption class="title">Table 1. Communication Roles</caption>
<col width="50%" />
<col width="50%" />
<thead>
<tr>
<th align="left" valign="top"> GNU APL </th>
<th align="left" valign="top"> Partner</th>
</tr>
</thead>
<tbody>
<tr>
<td align="left" valign="top"><p class="table">Client</p></td>
<td align="left" valign="top"><p class="table">Server</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Server</p></td>
<td align="left" valign="top"><p class="table">Client</p></td>
</tr>
<tr>
<td align="left" valign="top"><p class="table">Peer</p></td>
<td align="left" valign="top"><p class="table">Peer</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p>If GNU APL is the client or a peer in a communication then the communication
partner usually needs to exist before GNU APL can connect to the partner.
Some partners are being started beforehand by the operating system (Web
servers, SQL servers), some are started automatically by GNU APL (*APserver(
for shared variables) and some may need to be started by other means before
a GNU APL program can use them.</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_gnu_apl_communication_mechanisms_overview">GNU APL Communication Mechanisms Overview</h2>
<div class="sectionbody">
<div class="paragraph"><p>The following table gives an overview of the communication mechanisms that are
implemented in GNU APL. Most communication mechanisms are accessed from an APL
program via system variables. Some system variables need certain libraries and
if these libraries are not present at the time when GNU APL was
<strong>./configure&#8217;d</strong>, then these system variables will not exist
(raising a SYNTAX ERROR) or raise a DOMAIN ERROR. The fact that GNU APL is
in one role, for example as server, does not preclude it from being a client
in a different communication.</p></div>
<div class="tableblock">
<table rules="all"
width="100%"
frame="border"
cellspacing="0" cellpadding="4">
<caption class="title">Table 2. GNU APL Communication Mechanisms</caption>
<col width="31%" />
<col width="9%" />
<col width="18%" />
<col width="9%" />
<col width="31%" />
<thead>
<tr>
<th align="center" valign="top"> Mechanism</th>
<th align="center" valign="top"> GNU APL<br />
Role</th>
<th align="center" valign="top"> System Variable(s)</th>
<th align="center" valign="top"> TTFB</th>
<th align="center" valign="top"> Notes</th>
</tr>
</thead>
<tbody>
<tr>
<td align="center" valign="top"><p class="table">libapl</p></td>
<td align="center" valign="top"><p class="table">Server</p></td>
<td align="center" valign="top"><p class="table">-</p></td>
<td align="center" valign="top"><p class="table">low</p></td>
<td align="center" valign="top"><p class="table">-</p></td>
</tr>
<tr>
<td align="center" valign="top"><p class="table">Shared Variables<br />
(Workspace-to-Workspace)</p></td>
<td align="center" valign="top"><p class="table">Peer</p></td>
<td align="center" valign="top"><p class="table">⎕SVC ⎕SVO ⎕SVQ<br />
  ⎕SVR ⎕SVS</p></td>
<td align="center" valign="top"><p class="table">medium</p></td>
<td align="center" valign="top"><p class="table">for IBM APL2 compatibility only,<br />
  not to be used in new programs</p></td>
</tr>
<tr>
<td align="center" valign="top"><p class="table">Shared Variables<br />
(Auxiliary Processors)</p></td>
<td align="center" valign="top"><p class="table">Client</p></td>
<td align="center" valign="top"><p class="table">⎕SVC ⎕SVO ⎕SVQ<br />
  ⎕SVR ⎕SVS</p></td>
<td align="center" valign="top"><p class="table">medium</p></td>
<td align="center" valign="top"><p class="table">for IBM APL2 compatibility only,<br />
  not to be used in new programs</p></td>
</tr>
<tr>
<td align="center" valign="top"><p class="table">SQL Interface</p></td>
<td align="center" valign="top"><p class="table">Client</p></td>
<td align="center" valign="top"><p class="table">⎕SQL</p></td>
<td align="center" valign="top"><p class="table">low</p></td>
<td align="center" valign="top"><p class="table">Server is PostgreSQL or SQLite</p></td>
</tr>
<tr>
<td align="center" valign="top"><p class="table">Server forked by GNU APL</p></td>
<td align="center" valign="top"><p class="table">Client</p></td>
<td align="center" valign="top"><p class="table">⎕FIO[57]</p></td>
<td align="center" valign="top"><p class="table">medium</p></td>
<td align="center" valign="top"><p class="table">bidirectional pipe</p></td>
</tr>
<tr>
<td align="center" valign="top"><p class="table">popen()</p></td>
<td align="center" valign="top"><p class="table">Client</p></td>
<td align="center" valign="top"><p class="table">⎕FIO[24]</p></td>
<td align="center" valign="top"><p class="table">low</p></td>
<td align="center" valign="top"><p class="table">unidirectional pipe</p></td>
</tr>
<tr>
<td align="center" valign="top"><p class="table">Sockets</p></td>
<td align="center" valign="top"><p class="table">Any</p></td>
<td align="center" valign="top"><p class="table">⎕FIO[32 &#8230; 47]</p></td>
<td align="center" valign="top"><p class="table">medium</p></td>
<td align="center" valign="top"><p class="table">TCP, UDP, or U*ix Domain Sockets</p></td>
</tr>
<tr>
<td align="center" valign="top"><p class="table">Native functions</p></td>
<td align="center" valign="top"><p class="table">Any</p></td>
<td align="center" valign="top"><p class="table">dyadic ⎕FX</p></td>
<td align="center" valign="top"><p class="table">high</p></td>
<td align="center" valign="top"><p class="table">-</p></td>
</tr>
</tbody>
</table>
</div>
<div class="paragraph"><p><strong>Note:</strong> TTFB is the "Time To First Byte" of a communication and shall indicate
how long it takes to get a communication mechanism up and running (APL code
plus possibly code needed for the communication partner).</p></div>
</div>
</div>
<div class="sect1">
<h2 id="_gnu_apl_communication_mechanisms_details">GNU APL Communication Mechanisms Details</h2>
<div class="sectionbody">
<div class="paragraph"><p>In the following, the different communication mechanisms are described in
some more detail.</p></div>
<div class="sect2">
<h3 id="_libapl">libapl</h3>
<div class="paragraph"><p>Normally GNU APL initializes itself and then enters a <strong>REPL</strong> loop until
the )OFF command is given (interactive mode) or the input stream ends (script
mode). <strong>REPL</strong> stands for *R*ead-*E*valuate-*P*rint-*L*oop and that describes
the top-level operation of an APL interpreter in interactive mode.</p></div>
<div class="paragraph"><p>If GNU APL is <strong>./configure&#8217;d</strong> with option <strong>--with-libapl</strong>, then GNU APL does not
build a normal executable that can be started from a script or from a shell,
but it builds a library <strong>libapl</strong>. That library can then be linked with another
program that either implements its own <strong>REPL</strong> loop (thus providing some
interactive mode, but with a different user interface), or only call GNU APL
facilities from time to time.</p></div>
<div class="paragraph"><p>The following is an example C program that demonstrates the use of libapl:</p></div>
<div class="listingblock">
<div class="content">
<pre>

<code>#include "apl/libapl.h"

int
main(int argc, char * argv[])
{
   init_libapl(argv[0], 0);
   return apl_exec("⎕←2 3⍴⍳6");
}</code>

</pre>
</div></div>
<div class="paragraph"><p>If the code above is stored in, say, file <strong>test_libapl.c</strong>, and if libapl was
properly installed (and assuming the default installation prefix /usr/local of
GNU APL), the following command should create an executable file test_libapl:</p></div>
<div class="listingblock">
<div class="content">
<pre>

<code>gcc test_libapl.c -L /usr/local/lib/apl -lapl -o test_libapl</code>

</pre>
</div></div>
<div class="paragraph"><p>And running the newly created <strong>test_libapl</strong> gives what could be expected:</p></div>
<div class="listingblock">
<div class="content">
<pre>

<code>$ ./test_libapl
1 2 3
4 5 6</code>

</pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_shared_variables">Shared Variables</h3>
<div class="paragraph"><p>Shared variables is a communication mechanism that reaches back to the early
days of APL. In essence, a shared variable is an APL variable that represents
a communication channel to a peer. If one side assigns a value to a shared
variable, then the other side gets that value when referencing the variable
(and vice versa). The communication channel is established, maintained,
and closed by a set of system variables named <strong>⎕SVC</strong> (shared variable
control), <strong>⎕SVO</strong> (shared variable offer), <strong>⎕SVQ</strong> (shared variable query), <strong>⎕SVR</strong>
(shared variable retract), and <strong>⎕SVS</strong> (shared variable status). The details
of how these system variables are used will not be explained here, because
shared variables exist in GNU APL only for compatibility with IBM APL2. For
new APL programs, the socket functions in <strong>⎕FIO</strong> are much easier to use than
shared variables and have fewer restrictions.</p></div>
<div class="paragraph"><p>Shared variables come in 2 varieties:</p></div>
<div class="ulist"><ul>
<li>
<p>
workspace-to-workspace variables which create a communication link between
  two running APL workspaces (in different processes on the same machine. This
  is a peer-to-peer communication.
</p>
</li>
<li>
<p>
Auxiliary Processors (APs), which are processes started locally by the APL
  interpreter. In this case the APs are servers and APL is the client. GNU
  APL only implements 2 APs (AP100 and AP210) and only as examples for how
  to write other ones. In the past, APs were used to make specific operating
  services available to APL, but in GNU APL the same can be achieved with
  <strong>⎕FIO[57]</strong> for services defined by the user and/or <strong>⎕FIO[24]</strong> for services
  already available on the operating system.
</p>
</li>
</ul></div>
<div class="paragraph"><p>Those interested in the style of shared variables programming may have a
look at test cases <strong>AP100.tc</strong> for AP100, <strong>AP210.tc</strong> for AP210, and <strong>APnnn.tc</strong>
for workspace-to-workspace shared variables in the directory
<strong>src/test cases/</strong> of GNU APL.</p></div>
<div class="paragraph"><p>The GNU APL implementation of shared variables is a separate process running
the program <strong>APserver</strong> (which comes with GNU APL). APserver currently
implements only AP100 and AP210, but the source code of APserver is open, so
that a user can add more APs. Is seems, however, that most of the APs that
were not implemented have been superseded by more modern interfaces (most
of which are sub-functions of ⎕FIO) that are easier to use that shared
variables.</p></div>
<div class="paragraph"><p>For workspace-to-workspace shared variables, the APserver stores
the shared variables themselves, so that no data is lost if one of the
connected workspaces exits or *⎕SVR*s a shared variable. APserver also maps the
peer-to-peer connection between two workspaces onto two client/server
connections from each workspace (as clients) to APserver (as server). APserver
is started automatically when an APL workspace uses shared variables for the
first time.</p></div>
<div class="paragraph"><p>Since shared variables are considered obsolete, the effort put into their
implementation was kept at a minimum. As a consequence, the implementation
is rather crude and not optimized for performance.</p></div>
</div>
<div class="sect2">
<h3 id="_sql_interface">SQL Interface</h3>
<div class="paragraph"><p>The system function ⎕SQL provides a direct interface to an SQL database.
Currently PostgreSQL and SQLite databases are supported. ⎕SQL is a
container for a number of sub-functions that can be displayed with:</p></div>
<div class="listingblock">
<div class="content">
<pre>

<code>      ⎕SQL""
Available function numbers:
type  ⎕SQL[1] file      - open a database file, return reference ID for it
      ⎕SQL[2] ref       - close database
query ⎕SQL[3,db] params - send SQL query
query ⎕SQL[4,db] params - send SQL update
      ⎕SQL[5] ref       - begin a transaction
      ⎕SQL[6] ref       - commit current transaction
      ⎕SQL[7] ref       - rollback current transaction
      ⎕SQL[8] ref       - list tables
ref   ⎕SQL[9] table     - list columns for table</code>

</pre>
</div></div>
<div class="paragraph"><p>More details on <strong>⎕SQL</strong> can be found in <strong>info apl</strong> (around Section 3.24).</p></div>
</div>
<div class="sect2">
<h3 id="_server_forked_by_gnu_apl">Server forked by GNU APL</h3>
<div class="paragraph"><p><strong>Handle←⎕FIO[57] Bs</strong> spawns a process running the program <strong>Bs</strong>. <strong>Bs</strong> is the
<strong>absolute (!)</strong> path of an executable program or script, which is started
and connected to GNU APL over a bidirectional pipe.</p></div>
<div class="paragraph"><p>The return value <strong>Handle</strong> of <strong>⎕FIO[57] Bs</strong> is a file handle that can be used
on the APL side of the communication to send data to resp. receive data from
the spawned program using, for example, <strong>⎕FIO[6] Handle</strong> (aka <strong>fread</strong>) resp.
<strong>⎕FIO[8] Handle</strong> (aka. <strong>fwrite</strong>). The handle is normally closed with <strong>⎕FIO[4]
Handle</strong> (aka. <strong>fclose</strong>).</p></div>
<div class="paragraph"><p>At the spawned program&#8217;s end of the communication, the communication with
GNU APL uses file descriptor 3 which is normally only used to <strong>fdopen()</strong> a
FILE *. An <strong>fclose</strong> from the APL side causes an EOF condition (<strong>fread()</strong>
returns 0) in the spawned program. Under normal circumstances, the communication
should be closed from the client (= APL) side.</p></div>
<div class="paragraph"><p>The following is a simple example for a server written in "C", and GNU APL code
that forks the server and then sends a TLV (Tag-Length-Value) buffer to the
server. The server sends the TLV buffers back, but with the tag negated and the
value bytes mirrored.</p></div>
<div class="paragraph"><p>Client side (APL):</p></div>
<div class="listingblock">
<div class="content">
<pre>

<code>      Path ← '/usr/lib/apl/TLV_server'    ⍝ wherever TLV_server was installed
      Handle ← ⎕FIO[57] Path              ⍝ start &amp; connect TLV_server

      ⍝ typically in a loop,,,
      TLV ← 33 ⎕CR 42,'Forty-Two'         ⍝ encode a TLV buffer
      ⊣TLV ⎕FIO[43] Handle                ⍝ send TLV buffer to TLV_server
      TL ← 8 ⎕FIO[6] Handle               ⍝ read tag/length from TLV_server
      Value ← (256⊥4↓TL) ⎕FIO[6] Handle   ⍝ read value  from TLV_server
      34 ⎕CR TL,Value                     ⍝ display response tag and value

      ⍝ cleanup (one time)
      ⊣(⎕FIO[4] Handle)                   ⍝ close connection (stops
TLV_server)</code>

</pre>
</div></div>
<div class="paragraph"><p>Server side (C, this example can also be found in file tools/TLV_server.c):</p></div>
<div class="listingblock">
<div class="content">
<pre>

<code>#include &lt;errno.h&gt;
#include &lt;stdint.h&gt;
#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
#include &lt;unistd.h&gt;
#include &lt;sys/ioctl.h&gt;

int
main(int argc, char * argv[])
{
enum { TLV_socket = 3 };
char TLV[1000];       // the entire TLV buffer
char * V = TLV + 8;   // the value part of the TLV buffer
ssize_t rx_len, tx_len;
int32_t TLV_tag, TLV_len, j;

FILE * f = fdopen(TLV_socket, "r");
   if (f == 0)
      {
        fprintf(stderr,
"fdopen() failed: %s\n"
"That typically happens if this program is started directly,\n"
"more precisely: without opening file descriptor 3 first. The anticipated\n"
"usage is to open this program from GNU APL using ⎕FIO[57] and then to send\n"
"TLV buffers encoded with 33 ⎕CR and send to this program with ⎕FIO[43]\n"
        , strerror(errno));
        return 1;
      }

   for (;;)
       {
          // read the fixed size TL
          //
          rx_len = fread(TLV, 1, 8, f);
          if (rx_len != 8)
             {
               fprintf(stderr, "TLV socked closed (1): %s\n",
                       strerror(errno));
               fclose(f);
               return 0;
             }
          TLV_tag = TLV[0] &lt;&lt; 24 | TLV[1] &lt;&lt; 16 | TLV[2] &lt;&lt; 8 | TLV[3];
          TLV_len = TLV[4] &lt;&lt; 24 | TLV[5] &lt;&lt; 16 | TLV[6] &lt;&lt; 8 | TLV[7];

          // read the variable-sized V
          //
          if (TLV_len)
             {
               rx_len = fread(V, 1, TLV_len, f);
               if (rx_len != TLV_len)
                  {
                    fprintf(stderr, "TLV socked closed (2): %s\n",
                            strerror(errno));
                    fclose(f);
                    return 0;
                  }
               V[TLV_len] = 0;
             }

          // negate the tag
          //
          TLV_tag = -TLV_tag;
          TLV[0] = TLV_tag &gt;&gt;  24;
          TLV[1] = TLV_tag &gt;&gt;  16;
          TLV[2] = TLV_tag &gt;&gt;   8;
          TLV[3] = TLV_tag;

          // mirror the value
          //
          for (j = 0; j &lt; TLV_len/2; ++j)
              {
                const char tmp = V[j];
                V[j] = V[TLV_len - j - 1];
                V[TLV_len - j - 1] = tmp;
              }

           // send the response
          //
          tx_len = write(TLV_socket, TLV, 8 + TLV_len);
          if (tx_len != (8 + TLV_len))
             {
               fprintf(stderr, "TLV socked closed (3): %s\n", strerror(errno));
               fclose(f);
               return 0;
             }
       }
}</code>

</pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_popen">popen()</h3>
<div class="paragraph"><p><strong>Handle←⎕FIO[24] Bs</strong> (aka. <strong>popen</strong>) performs a function similar to <strong>⎕FIO[57]</strong>
above, but with the following differences:</p></div>
<div class="ulist"><ul>
<li>
<p>
the pipe is unidirectional
</p>
<div class="ulist"><ul>
<li>
<p>
either to stdin (file descriptor 0) of the spawned process,
</p>
</li>
<li>
<p>
or to stdout (file descriptor 1) of the spawned process
</p>
</li>
</ul></div>
</li>
<li>
<p>
the pipe is closed with <strong>⎕FIO[24] Handle</strong> (aka. <strong>pclose</strong>) instead of
  <strong>pclose</strong>.
</p>
</li>
</ul></div>
<div class="paragraph"><p>The following APL code executes the operating system command ls and prints
its output:</p></div>
<div class="listingblock">
<div class="content">
<pre>

<code>      Command←"ls"
      Handle←⎕FIO[24] Command    ⍝ PIPE = popen("ls")
      Data←⎕FIO[6] Handle        ⍝ fread(PIPE)
      ⎕UCS Data                  ⍝ display fread() output
      ⎕FIO[25] Handle            ⍝ pclose(PIPE)</code>

</pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_sockets">Sockets</h3>
<div class="paragraph"><p>The <strong>⎕FIO</strong> functions 32&#8230;47, i.e. <strong>⎕FIO[32]</strong>, <strong>⎕FIO[33]</strong>, &#8230; <strong>⎕FIO[47]</strong>
give APL access to the most common socket functions in libstdc. APL can use
these function to set up sockets in a way that specific low-level properties
can be set via socket options, transport protocol options, and the like.
The use of these functions requires some experience with socket programming.</p></div>
<div class="paragraph"><p><strong>info apl</strong> (around section 3.20) provides some more details about ⎕FIO. One
can do ⎕FIO "" to obtain a list of ⎕FIO sub-function, in particular the names
of the corresponding functions in the libstdc library.</p></div>
<div class="paragraph"><p>That function name can then used with <strong>man</strong> command which explains the
expected function arguments. By and large ⎕FIO takes the same arguments as
the corresponding libc functions, but some of the function arguments (in
particular those taking pointer arguments) were mapped to APL byte arrays.</p></div>
<div class="paragraph"><p>The test case file <strong>src/test cases/Quad_FIO.tc</strong> contains APL code for a short
client/server communication between two TCP sockets on Port 22222 (around
line 170 of the test case file).</p></div>
</div>
<div class="sect2">
<h3 id="_native_functions">Native functions</h3>
<div class="paragraph"><p>If the capabilities provided by sockets are still not enough, then one
can get complete control by means of GNU APL native function. A native
function is a function that can be called from APL (and returns results back
to APL, but has an implementation in a different language (typically C or
C++).</p></div>
<div class="paragraph"><p>Writing native functions is a little more complicated than using communication
facilities already present in APL like the mechanisms explained so far. The
design and use of a native function consists of the following steps:</p></div>
<div class="paragraph"><p>First of all, preparation of a dynamic library that contains implementations
for those function signatures that the native function shall support. For
example, suppose a function FOO shall support the 3 signatures</p></div>
<div class="ulist"><ul>
<li>
<p>
dyadic function call, i.e. <strong>Z←A FOO B</strong>,
</p>
</li>
<li>
<p>
monadic function call, i.e.  <strong>Z←FOO B</strong>, and
</p>
</li>
<li>
<p>
monadic function with axis call, i.e.  <strong>Z←FOO[X] B</strong>.
</p>
</li>
</ul></div>
<div class="paragraph"><p>The native function library then needs to implement 3 functions and make them
accessible via <strong>dlsym()</strong>.</p></div>
<div class="paragraph"><p>After the dynamic library, say <strong>FOO.so</strong>, has been created, GNU APL can open
the dynamic library, with:</p></div>
<div class="listingblock">
<div class="content">
<pre>

<code>      'FOO.so' ⎕FX 'FOO'</code>

</pre>
</div></div>
<div class="paragraph"><p>That makes the 3 signatures implemented <strong>FOO.so</strong> available in APL (for the
same signatures).</p></div>
<div class="paragraph"><p><strong>Note:</strong> Native functions were not primarily intended for communication purposes.
But since they import the full power of C/C++ into GNU APL they are a last
resort if all methods above cannot be used.</p></div>
<div class="paragraph"><p>The directory <strong>src/native</strong> contains C++ code templates for different APL
function signatures. You can use these templates as a starting point for your
own native function(s). If you modify a template in-place (i.e.
you do NOT copy and rename it) then the GNU APL build system will compile
your changes and create .so files in directory <strong>src/native/.libs</strong> that can
be ⎕FXed later on.</p></div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_communication_over_streams">Communication over streams</h2>
<div class="sectionbody">
<div class="paragraph"><p>The majority of the communication mechanisms above use - explicitly or
implicitly - some sort of data framing between the communication partners.
This data framing divides the entire communication between the partners into
several transactions, where one transaction is, depending on the mechanism:</p></div>
<div class="ulist"><ul>
<li>
<p>
one libapl function call, or
</p>
</li>
<li>
<p>
one shared variable assignment, or
</p>
</li>
<li>
<p>
one write() to a ⎕FIO[57] pipe, or
</p>
</li>
<li>
<p>
one SQL query, or
</p>
</li>
<li>
<p>
one datagram sent over a socket of type SOCK_DGRAM, or
</p>
</li>
<li>
<p>
one native function call.
</p>
</li>
</ul></div>
<div class="paragraph"><p>The remaining mechanisms:</p></div>
<div class="ulist"><ul>
<li>
<p>
popen(),
</p>
</li>
<li>
<p>
sockets of type SOCK_STREAM
</p>
</li>
</ul></div>
<div class="paragraph"><p>send their data in a byte-by-byte fashion, which may cause a problem for the
receiver because the receiver cannot reliably detect the boundaries between
different transactions. In these cases the division of the byte stream(s)
between the communication partners into transactions has to be performed by
the APL application, and GNU APL provides a few system functions that can
be used to <strong>frame</strong> (read: encode) an item at the sender side into a sequence
of bytes, and to <strong>de-frame</strong> (read: decode) the received byte stream back into
the item that was sent at the receiver side. The <strong>frame</strong> and <strong>de-frame</strong>
functions cooperate in such a way that;</p></div>
<div class="listingblock">
<div class="content">
<pre>

<code>      item ≡ decode encode item
      decode ((encode A),(encode B)) ≡ (decode encode A), (decode encode B)</code>

</pre>
</div></div>
<div class="paragraph"><p>The <strong>frame</strong> and <strong>de-frame</strong> differ by the kind of item that is to be sent over
a byte stream.</p></div>
<div class="sect2">
<h3 id="_tag_length_value_aka_tlv">Tag/Length/Value aka. TLV</h3>
<div class="paragraph"><p>TLV is a frequently used format for sending byte vectors over a stream. The
byte vector is prepended by a tag field and a length field indicating the
length of the byte vector. The tag and length fields have a fixed size
(typically 1, 2, or 4 bytes) while the length of the byte vector can vary.
Decoding of the TLV is very simple and efficient. The de-framing as such only
requires the length field, but the tag is often required to distinguish
different data types sent over the same stream.</p></div>
<div class="paragraph"><p>System function <strong>33 ⎕CR</strong> converts <strong>TAG,byte-vector</strong> to a TLV (sender side)
while its inverse function <strong>¯33 ⎕CR</strong>  converts a TLV back to
<strong>TAG,byte-vector</strong>. Example:</p></div>
<div class="listingblock">
<div class="content">
<pre>

<code>      5 ⎕CR  33 ⎕CR 42,"Hello"
0000002A0000000548656C6C6F
 │ │ │ │ │ │ │ │ │ │ │ │ │
 │ │ │ │ │ │ │ │ └─┴─┴─┴─┴───── "Hello"
 │ │ │ │ └─┴─┴─┴─────────────── 5 (length)
 └─┴─┴─┴─────────────────────── 42 (tag)

     ¯33 ⎕CR 33 ⎕CR 42,"Hello"
42 Hello</code>

</pre>
</div></div>
</div>
<div class="sect2">
<h3 id="_lines_terminated_by_line_feeds">Lines terminated by line feeds</h3>
<div class="paragraph"><p>Many programs, in particular operating system commands, write their output
line-by-line to their <strong>stdout</strong>. If these programs are started from APL with
<strong>Handle←24 ⎕FIO[24] Bs</strong> (aka. popen(Bs, "r") then the handle returned to APL
is a stream of lines that are terminated by line feeds (ASCII 10 or <strong>\n</strong>).
The first step in the processing of such a stream in APL is usually to split
the stream into a (nested) vector of lines. This can be easily and efficiently
done with <strong>35 ⎕CR</strong>. The terminating line feeds are removed in this conversion.</p></div>
<div class="paragraph"><p>Example:</p></div>
<div class="listingblock">
<div class="content">
<pre>

<code>      9 ⎕CR   35 ⎕CR "Hello\nWorld\n"
╔═══════════════╗
║┏→━━━━┓ ┏→━━━━┓║
║┃Hello┃ ┃World┃║
║┗━━━━━┛ ┗━━━━━┛║
╚═══════════════╝</code>

</pre>
</div></div>
</div>
</div>
</div>
</div>
<div id="footnotes"><hr /></div>
<div id="footer">
<div id="footer-text">
Last updated 2020-05-03 16:04:14 CEST
</div>
</div>
</body>
</html>
